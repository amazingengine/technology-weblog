= GCEのインスタンスをほぼ無料で立ち上げてみました♪
cacapon
v1.0, 2019-08-16 18:00
:page-category: プログラミング
:page-thumbnail: /images/cacapon/002/GCP.png

# <はじめに>

こんにちは、cacaponです～ +
前回のブログを見ていただいた方、ありがとうございました～ +
何点かご感想もくれた方がおりまして、大変うれしく思っております～♪ +



中には厳しい言付けを仰って頂いた方もいましたが、 +
cacaponなりに見やすいブログにしていきたいと思いますので、 +
これからもよろしくお願いします♪



さて、本日のブログの内容ですが、 +
皆さんGoogle Cloud Platform(GCP)は使っておりますでしょうか？

今回はその中にある Google Compute Engine(GCE)という +
PaaSを使ってLinuxの仮想環境を立ち上げるまでを紹介したいと思います♪ +

仮想環境の立ち上げってcacapon的にはお値段が高そうなのですが… +
なんと、通常は料金がかかるところ、設定によってはほぼ無料で使えますよ！ +
という記事もちらほら見つけました！

<参考にしたURL> +
https://qiita.com/Brutus/items/22dfd31a681b67837a74
https://qiita.com/ndxbn/items/7ef0a96e409a5b5837bd


今回はそれを試していきたいと思います～♪

# <必要なもの>

* GCPの登録
** クレジットカード
** Googleアカウント

…なのだそうですが、実は今回既に登録済みの「会社のGCP」と私のアカウントを紐づける形で使わせていただきました～ +
ですので、参考URLのような１から作成する手順と異なりますのでご了承ください～

# 事前準備 IAMで権限を設定してもらう

まずは、自分のアカウントで色々操作できるようにする必要があります～ +
なので、プロジェクトのオーナーさんにお願いして権限を設定してもらってください～


# 手順

## 1:VMインスタンスを立ち上げる

Google Compute Engineを選択して、作成ボタンを押します～

image::cacapon/002/01_make_instance1.png[]

下記の注意事項に注意しながら設定してください～

* 名前:任意で大丈夫です～
* リージョン:us-east4以外のus-xxxxxxを選択します～
* マシンタイプは f1-microにします～
* ブートディスクの容量は30GBまで無料なので30GBにします～

image::cacapon/002/01_make_instance2.png[]

image::cacapon/002/01_make_instance3.png[]

image::cacapon/002/01_make_instance4.png[]


また、今回お試しで使うアプリがwebに公開するものなので、以下の設定も行いました～

* HTTP,HTTPSのトラフィックを許可します～
* グローバルIPアドレスを割り当てます～※

※割り当ててないグローバルIPは課金対象なので、 +
インスタンスを消す場合はすぐIPアドレスも開放しましょう～

image::cacapon/002/01_make_instance5.png[]

image::cacapon/002/01_make_instance6.png[]

image::cacapon/002/01_make_instance7.png[]

これで、ページ下部にある作成を押せば、インスタンスが出来上がります～ +
出来上がるまでしばらく待ちましょう～

## 2:公開鍵を設定する。

GCEで使うsshの公開鍵を作ります～ +
今回はed25519を使いました～

まず、自前のbashを開いて下記のように入力します。 +
`ssh-keygen -t ed25519 -P "" -f <鍵の名前> -C "<cacaponのメールアドレス>"`

そうすると、<鍵の名前>.pubというファイルができるので、
中身をGCEに登録します～

GCE内のメタデータを選択して、編集ボタンを押します～

image::cacapon/002/02_setting_sshkey1.png[]

項目の追加を押した後、<鍵の名前>.pubを貼り付けて保存しましょう～

image::cacapon/002/02_setting_sshkey2.png[]


## 3:アクセスできるポート番号を22番から別の番号に変更する。

これでインスタンスにアクセスできるようになったのですが、 +
参考先のURLによると、22番は外部からの不正アクセスによって、 +
課金が発生する可能性が高いらしいのです～

不正アクセスも嫌ですし、それで課金が発生するのも嫌ですので +
ポート22番を閉じて他のポート番号でアクセス出来るようにしましょう～

### 3-1:22番以外のポートを許可する。

まずは、ファイアウォールの設定で22番以外のポートでアクセス出来るように設定します～

VCPネットワークのファイアウォールのルールにして、 +
ファイアウォールルールを作成を押しましょう～

今回は、50000番のポートにしたいと思います～

image::cacapon/002/03_change_tcpport1.png[]

以下の部分を設定していきます～

* 名前：任意の名前
* 一致したときのアクション:許可
* ターゲットタグ:インスタンスが認識するタグを設定 +
今回はallow-50000 にしてます～ 
* ソースIPの範囲:0.0.0.0/0
* プロトコルとポート:tcpにチェックを入れ、50000を入力します～

image::cacapon/002/03_change_tcpport2.png[]

image::cacapon/002/03_change_tcpport3.png[]

こちらの設定が終わりましたら、保存を押します～

次に、インスタンスにファイアウォールのルールを紐づけます～

VMインスタンスに戻り、編集ボタンを押します～

image::cacapon/002/03_change_tcpport4.png[]

ネットワークタグという場所があるので、 +
こちらに、さきほど作成したネットワークタグを入力します～

入力したら保存しましょう～
これで、50000ポートでアクセスするようになりました～

### 3-2: インスタンス内のポート設定を切り替える。

50000ポートの許可は作りましたが、インスタンス内の設定はまだできてません。アクセスして変更しましょう～

まずは、写真のように選択し、22番でアクセスしましょう～

image::cacapon/002/03_change_tcpport6.png[]

しばらく待つと、CLIの画面が出ます～ +
インスタンスの中に入れました～

入力したら、下記コマンドを実行し +
`sudo vi /etc/ssh/sshd_config`

`# Port 22` を `Port 50000` に変更して保存します～

image::cacapon/002/03_change_tcpport7.png[]


終わりましたら、下記コマンドを実行します。 +
`sudo systemctl restart sshd`

これで、ポート番号が50000に切り替わりました～

インスタンスのブラウザは落とさずに、50000ポートでアクセスできる確認しましょう～

ブラウザウィンドウでカスタムポートを開くを押せば、別のウィンドウでもう一度立ち上がります♪

### 3-3: 22番ポートでのアクセスを禁止する。

ここまで出来たら、22番ポートでアクセスできないようにしましょう～

手順は…

* ファイアウォールのルールを作る
* VMインスタンスに紐づける

…と3-1とほぼ一緒ですが、
一致したときのアクションだけ拒否にするところだけ異なります～

なお、今回のターゲットタグはdisallow-22としています～

ここまで出来ましたら、カスタムポートの22番でアクセスを試してください♪ +
正しく設定されていればアクセスできなくなっているはずです～

## 4:インスタンス内の準備

次は、インスタンス内に必要なツールを入れていきます～ +
今回は弊社で利用している以下のツールをインストールしました～

* https://docs.docker.com/install/linux/docker-ce/debian/[Docker] 
* https://docs.docker.com/compose/install/[Docker-compose] 
* https://www.digitalocean.com/community/tutorials/how-to-install-git-on-debian-9[git] 
各インストールにつきましては、リンク先を参照してください～

## 5:いざ、実行！

準備が出来ましたら、`git clone` で弊社が作成したリポジトリをLinux環境に落とし、
事前準備設定後、`sudo docker-compose up -d` でバックグラウンドで実行させました♪

今回実行したのはwebページ上で英語試験問題が解けるという弊社のアプリなのですが、 +
無事にhttpでアクセス出来ました♪ Linux上でもちゃんと動いてますね♪

image::cacapon/002/04_run_image.png[]



さて、ここまでで、GCPを使ったLinuxの立ち上げまでを順を追って説明しましたが、
いかがでしたでしょうか？ +
これがほぼ無料でできるってすごいですね…

ちなみに、ほぼ無料と言っているのは、11月がサマータイムの関係で1時間多いらしいからだそうです。 +
11月だけ1円課金されるとのこと。
https://qiita.com/hnw/items/8a422ccbc63dfbd9e3b9

ずっと動いておいてほしい環境で試したいときなんかに +
良かったら試してみてくださいませ～

最後まで読んでくれてありがとうございました！ +
また次のブログで会いましょ～
